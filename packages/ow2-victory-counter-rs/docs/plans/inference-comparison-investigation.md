# æ¨è«–çµæœå·®ç•°èª¿æŸ»ãƒ»è§£æ±ºè¨ˆç”»

## æ¦‚è¦

### å•é¡Œã®èª¬æ˜

Rustç‰ˆï¼ˆONNXï¼‰ã§ã®æ¨è«–ã§ã€none ã‚¯ãƒ©ã‚¹ã® confidence ãŒé »ç¹ã« 1.00 ã«ãªã‚‹ç¾è±¡ãŒè¦³å¯Ÿã•ã‚Œã¦ã„ã¾ã™ã€‚

```
Prediction: [defeat_progressbar=0.00, defeat_text=0.00, none=1.00, victory_progressbar=0.00, victory_text=0.00] -> outcome=none (confidence=1.00)
```

ã“ã‚Œã¯PoCã®PyTorchæ¨è«–ã¨æ¯”è¼ƒã—ã¦ã€æ¨è«–çµæœã«å·®ç•°ãŒã‚ã‚‹å¯èƒ½æ€§ã‚’ç¤ºå”†ã—ã¦ã„ã¾ã™ã€‚

### èª¿æŸ»ã®ç›®çš„

1. PoCã¨Rustç‰ˆã®å‰å‡¦ç†ã®é•ã„ã‚’ç‰¹å®šã™ã‚‹
2. åŒã˜ç”»åƒã§ä¸¡æ–¹ã®æ¨è«–çµæœã‚’æ¯”è¼ƒã™ã‚‹
3. å¿…è¦ã«å¿œã˜ã¦å‰å‡¦ç†ã‚’ä¿®æ­£ã—ã€æ¨è«–ç²¾åº¦ã‚’å‘ä¸Šã•ã›ã‚‹

### æ—¢çŸ¥ã®å·®ç•°

èª¿æŸ»ã«ã‚ˆã‚Šä»¥ä¸‹ã®å·®ç•°ãŒåˆ¤æ˜ã—ã¦ã„ã¾ã™ï¼š

| é …ç›® | PoC (Python) | Rustç‰ˆ | ä¸€è‡´ |
|------|-------------|--------|------|
| æ­£è¦åŒ– | 0-1 (/ 255.0) | 0-1 (/ 255.0) | âœ… |
| è‰²ç©ºé–“ | RGB | RGB | âœ… |
| ãƒ†ãƒ³ã‚½ãƒ«å½¢å¼ | NCHW | NCHW | âœ… |
| ãƒªã‚µã‚¤ã‚º | ã‚¢ã‚¹ãƒšã‚¯ãƒˆæ¯”ç¶­æŒ or ãªã— | **å›ºå®šã‚µã‚¤ã‚ºå¼·åˆ¶** | âŒ |
| ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ | cv2.INTER_LINEAR | FilterType::Triangle | â–³ |

**ä¸»ãªå•é¡Œ**: ãƒªã‚µã‚¤ã‚ºæ–¹æ³•ãŒç•°ãªã‚‹å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™ã€‚

---

## ãƒ•ã‚§ãƒ¼ã‚º1: PoCã®å‡¦ç†æ–¹æ³•ã‚’ç¢ºèªï¼ˆèª¿æŸ»ï¼‰

### 1.1 PoCã®å®Ÿè¡Œè¨­å®šã‚’ç¢ºèª

**ç¢ºèªé …ç›®**:
- `packages/obs-victory-counter/victory-detector/start.ps1`
- `--image-size` ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ãŒæŒ‡å®šã•ã‚Œã¦ã„ã‚‹ã‹
- æŒ‡å®šã•ã‚Œã¦ã„ã‚‹å ´åˆã€ãã®ã‚µã‚¤ã‚ºï¼ˆä¾‹: 512, 283ãªã©ï¼‰

**ç¢ºèªæ–¹æ³•**:
```bash
# start.ps1 ã‚’ç¢ºèª
cat packages/obs-victory-counter/victory-detector/start.ps1 | grep image-size

# ã¾ãŸã¯å®Ÿè¡Œãƒ­ã‚°ã‚’ç¢ºèª
```

**åˆ¤å®šåŸºæº–**:
- `--image-size` ãŒ**æŒ‡å®šã•ã‚Œã¦ã„ã‚‹** â†’ ãƒªã‚µã‚¤ã‚ºã‚ã‚Š
- `--image-size` ãŒ**æŒ‡å®šã•ã‚Œã¦ã„ãªã„** â†’ ãƒªã‚µã‚¤ã‚ºãªã—ï¼ˆ995x550ã®ã¾ã¾ï¼‰

### 1.2 å­¦ç¿’æ™‚ã®ç”»åƒã‚µã‚¤ã‚ºã‚’ç¢ºèª

**ç¢ºèªé …ç›®**:
- å­¦ç¿’ãƒ‡ãƒ¼ã‚¿ã‚»ãƒƒãƒˆã®ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ
- ãƒ¢ãƒ‡ãƒ«ãƒˆãƒ¬ãƒ¼ãƒ‹ãƒ³ã‚°æ™‚ã®è¨­å®š

**ç¢ºèªæ–¹æ³•**:
```bash
# ãƒ‡ãƒ¼ã‚¿ã‚»ãƒƒãƒˆä½œæˆã‚¹ã‚¯ãƒªãƒ—ãƒˆã‚’ç¢ºèª
cat packages/obs-victory-counter/victory-detector/scripts/create_dataset.py

# å­¦ç¿’ã‚¹ã‚¯ãƒªãƒ—ãƒˆã‚’ç¢ºèª
cat packages/obs-victory-counter/victory-detector/scripts/train.py
```

**æœŸå¾…ã•ã‚Œã‚‹æƒ…å ±**:
- å­¦ç¿’ãƒ‡ãƒ¼ã‚¿ã®è§£åƒåº¦
- ãƒ¢ãƒ‡ãƒ«ãŒæœŸå¾…ã™ã‚‹å…¥åŠ›ã‚µã‚¤ã‚º

---

## ãƒ•ã‚§ãƒ¼ã‚º2: ãƒ‡ãƒãƒƒã‚°ç”¨ç”»åƒä¿å­˜æ©Ÿèƒ½ã®è¿½åŠ  âœ… å®Ÿè£…å®Œäº†

**å®Ÿè£…æ—¥**: 2025-01-21
**ã‚³ãƒŸãƒƒãƒˆãƒãƒƒã‚·ãƒ¥**: c76d487

### 2.1 è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ã®æ‹¡å¼µ

`config.example.toml` ã«ä»¥ä¸‹ã®ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã‚’è¿½åŠ :

```toml
[debug]
# ãƒ‡ãƒãƒƒã‚°æ©Ÿèƒ½ï¼ˆé–‹ç™ºãƒ»æ¤œè¨¼ç”¨ï¼‰
enabled = false
save_dir = "debug"
save_cropped = true        # ã‚¯ãƒ­ãƒƒãƒ—å¾Œã®å…ƒç”»åƒã‚’ä¿å­˜
save_preprocessed = true   # å‰å‡¦ç†å¾Œï¼ˆãƒªã‚µã‚¤ã‚ºå¾Œï¼‰ã®ç”»åƒã‚’ä¿å­˜
save_results = true        # æ¨è«–çµæœJSONã‚’ä¿å­˜
```

### 2.2 å®Ÿè£…å†…å®¹

#### src/config.rs

```rust
#[derive(Debug, Clone, Serialize, Deserialize)]
pub struct DebugConfig {
    #[serde(default = "default_debug_enabled")]
    pub enabled: bool,
    #[serde(default = "default_debug_save_dir")]
    pub save_dir: PathBuf,
    #[serde(default = "default_debug_save_cropped")]
    pub save_cropped: bool,
    #[serde(default = "default_debug_save_preprocessed")]
    pub save_preprocessed: bool,
    #[serde(default = "default_debug_save_results")]
    pub save_results: bool,
}

fn default_debug_enabled() -> bool { false }
fn default_debug_save_dir() -> PathBuf { PathBuf::from("debug") }
fn default_debug_save_cropped() -> bool { true }
fn default_debug_save_preprocessed() -> bool { true }
fn default_debug_save_results() -> bool { true }
```

#### src/main.rsï¼ˆæ¤œçŸ¥ãƒ«ãƒ¼ãƒ—ï¼‰

```rust
// ãƒ‡ãƒãƒƒã‚°ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªä½œæˆ
if config.debug.enabled {
    tokio::fs::create_dir_all(&config.debug.save_dir).await?;
    info!("Debug mode enabled: {}", config.debug.save_dir.display());
}

// æ¤œçŸ¥ãƒ«ãƒ¼ãƒ—å†…
loop {
    // ç”»åƒã‚­ãƒ£ãƒ—ãƒãƒ£
    let image = obs_capture.capture().await?;

    // ãƒ‡ãƒãƒƒã‚°: å…ƒç”»åƒã‚’ä¿å­˜
    if config.debug.enabled && config.debug.save_cropped {
        let timestamp = Local::now().format("%Y%m%d-%H%M%S-%3f");
        let path = config.debug.save_dir.join(format!("cropped-{}.png", timestamp));
        image.save(&path)?;
    }

    // å‰å‡¦ç†
    let processed = obs_capture.preprocess(image.clone(), crop_rect)?;

    // ãƒ‡ãƒãƒƒã‚°: å‰å‡¦ç†å¾Œã®ç”»åƒã‚’ä¿å­˜
    if config.debug.enabled && config.debug.save_preprocessed {
        let timestamp = Local::now().format("%Y%m%d-%H%M%S-%3f");
        let path = config.debug.save_dir.join(format!("preprocessed-{}.png", timestamp));
        processed.save(&path)?;
    }

    // æ¨è«–
    let detection = predictor.predict(&processed)?;

    // ãƒ‡ãƒãƒƒã‚°: æ¨è«–çµæœã‚’ä¿å­˜
    if config.debug.enabled && config.debug.save_results {
        let timestamp = Local::now().format("%Y%m%d-%H%M%S-%3f");
        let result_json = serde_json::json!({
            "timestamp": timestamp.to_string(),
            "outcome": detection.outcome,
            "confidence": detection.confidence,
            "predicted_class": detection.predicted_class,
            "probabilities": detection.probabilities,
        });
        let path = config.debug.save_dir.join(format!("result-{}.json", timestamp));
        tokio::fs::write(&path, serde_json::to_string_pretty(&result_json)?).await?;
    }

    // ... ä»¥é™ã¯æ—¢å­˜ã®å‡¦ç†
}
```

### 2.3 ç›®çš„

ã“ã®æ©Ÿèƒ½ã«ã‚ˆã‚Šä»¥ä¸‹ãŒå¯èƒ½ã«ãªã‚Šã¾ã™:

1. **ã‚¯ãƒ­ãƒƒãƒ—é ˜åŸŸã®æ¤œè¨¼**: ã‚¯ãƒ­ãƒƒãƒ—å¾Œã®ç”»åƒã‚’ç›®è¦–ç¢ºèªã—ã€å‹æ•—è¡¨ç¤ºãŒæ­£ã—ãå«ã¾ã‚Œã¦ã„ã‚‹ã‹ç¢ºèª
2. **å‰å‡¦ç†ã®æ¤œè¨¼**: ãƒªã‚µã‚¤ã‚ºå¾Œã®ç”»åƒã‚’ç¢ºèªã—ã€æ­ªã¿ã‚„åŠ£åŒ–ã‚’ç¢ºèª
3. **PoCæ¯”è¼ƒç”¨ãƒ‡ãƒ¼ã‚¿**: ä¿å­˜ã—ãŸç”»åƒã‚’PoCã§æ¨è«–ã—ã€çµæœã‚’æ¯”è¼ƒ
4. **æ¨è«–çµæœã®è¨˜éŒ²**: ã‚¿ã‚¤ãƒ ã‚¹ã‚¿ãƒ³ãƒ—ä»˜ãã§æ¨è«–çµæœã‚’è¨˜éŒ²

### 2.4 å¤‰æ›´ãƒ•ã‚¡ã‚¤ãƒ«ä¸€è¦§

1. `config.example.toml`: [debug] ã‚»ã‚¯ã‚·ãƒ§ãƒ³è¿½åŠ 
2. `src/config.rs`: DebugConfig æ§‹é€ ä½“è¿½åŠ 
3. `src/main.rs`: ãƒ‡ãƒãƒƒã‚°ç”»åƒãƒ»çµæœä¿å­˜å‡¦ç†è¿½åŠ 

---

## ãƒ•ã‚§ãƒ¼ã‚º2.5: å˜ä¸€ç”»åƒæ¨è«–æ©Ÿèƒ½ã®å®Ÿè£… âœ… å®Ÿè£…å®Œäº†

**å®Ÿè£…æ—¥**: 2025-01-21

### æ¦‚è¦

PoCã¨Rustã®æ¨è«–çµæœã‚’åŒã˜ç”»åƒã§æ¯”è¼ƒã§ãã‚‹ã‚ˆã†ã«ã€ä¸¡æ–¹ã«å˜ä¸€ç”»åƒæ¨è«–æ©Ÿèƒ½ã‚’å®Ÿè£…ã—ã¾ã—ãŸã€‚

### å®Ÿè£…å†…å®¹

#### PoC (Python)

**ãƒ•ã‚¡ã‚¤ãƒ«**: `packages/obs-victory-counter/victory-detector/scripts/inference_single_image.py`

```bash
uv run python scripts/inference_single_image.py \
  --image path/to/image.png \
  --model artifacts/models/victory_classifier.pth \
  [--output result.json] \
  [--size 512] \
  [--no-crop]
```

**æ©Ÿèƒ½**:
- å˜ä¸€ç”»åƒãƒ•ã‚¡ã‚¤ãƒ«ã«å¯¾ã—ã¦PyTorchæ¨è«–ã‚’å®Ÿè¡Œ
- ã‚¯ãƒ­ãƒƒãƒ—ã¨ãƒªã‚µã‚¤ã‚ºã®åˆ¶å¾¡ãŒå¯èƒ½
- JSONå½¢å¼ã§çµæœã‚’å‡ºåŠ›ï¼ˆRustç‰ˆã¨äº’æ›ï¼‰

#### Rustç‰ˆ

**å¤‰æ›´ãƒ•ã‚¡ã‚¤ãƒ«**: `src/main.rs`

```bash
cargo run --release -- predict \
  --image path/to/image.png \
  --model models/victory_classifier.onnx \
  --label-map models/victory_classifier.label_map.json \
  [--output result.json] \
  [--no-crop]
```

**æ©Ÿèƒ½**:
- ã‚µãƒ–ã‚³ãƒãƒ³ãƒ‰æ–¹å¼ã®æ¡ç”¨ï¼ˆ`server` / `predict`ï¼‰
- ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã¯serverãƒ¢ãƒ¼ãƒ‰ï¼ˆæ—¢å­˜ã®å‹•ä½œã‚’ç¶­æŒï¼‰
- predictãƒ¢ãƒ¼ãƒ‰ã§å˜ä¸€ç”»åƒæ¨è«–ã‚’å®Ÿè¡Œ
- `--no-crop` ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã§ãƒ‡ãƒãƒƒã‚°ç”»åƒã‚’ãã®ã¾ã¾æ¨è«–å¯èƒ½

### JSONå‡ºåŠ›å½¢å¼

ä¸¡æ–¹ã®ãƒ„ãƒ¼ãƒ«ã§åŒã˜å½¢å¼ã®JSONå‡ºåŠ›ã«å¯¾å¿œï¼š

```json
{
  "image": "path/to/image.png",
  "outcome": "victory",
  "confidence": 0.95,
  "predicted_class": "victory_text",
  "probabilities": [
    { "class": "defeat_progressbar", "probability": 0.01 },
    { "class": "defeat_text", "probability": 0.02 },
    { "class": "none", "probability": 0.02 },
    { "class": "victory_progressbar", "probability": 0.00 },
    { "class": "victory_text", "probability": 0.95 }
  ]
}
```

### æˆæœ

- âœ… PoCã¨Rustã§åŒã˜ç”»åƒã‚’æ¨è«–å¯èƒ½ã«
- âœ… JSONå‡ºåŠ›å½¢å¼ã‚’çµ±ä¸€ã—ã¦æ¯”è¼ƒãŒå®¹æ˜“ã«
- âœ… ãƒ‡ãƒãƒƒã‚°ãƒ¢ãƒ¼ãƒ‰ã§ä¿å­˜ã—ãŸç”»åƒã‚’ç›´æ¥æ¨è«–å¯èƒ½
- âœ… ãƒ•ã‚§ãƒ¼ã‚º3ï¼ˆæ¯”è¼ƒãƒ†ã‚¹ãƒˆï¼‰ã®æº–å‚™å®Œäº†

---

## ãƒ•ã‚§ãƒ¼ã‚º3: æ¯”è¼ƒãƒ†ã‚¹ãƒˆ âœ… å®Œäº†

**å®Ÿæ–½æ—¥**: 2025-01-22

### 3.1 Rustç‰ˆã§ç”»åƒã‚’ä¿å­˜

**æ‰‹é †**:

1. `config.toml` ã§ãƒ‡ãƒãƒƒã‚°ãƒ¢ãƒ¼ãƒ‰ã‚’æœ‰åŠ¹åŒ–:
   ```toml
   [debug]
   enabled = true
   save_dir = "debug"
   save_cropped = true
   save_preprocessed = true
   save_results = true
   ```

2. Rustç‰ˆã‚’å®Ÿè¡Œ:
   ```bash
   cargo run --release
   ```

3. none æ¤œçŸ¥æ™‚ã®ç”»åƒã‚’åé›†ï¼ˆæ•°æšï¼‰
4. victory/defeat æ¤œçŸ¥æ™‚ã®ç”»åƒã‚‚åé›†ï¼ˆå‚è€ƒç”¨ï¼‰

### 3.2 PoCã§åŒã˜ç”»åƒã‚’æ¨è«–

**æ‰‹é †**:

1. ä¿å­˜ã—ãŸã‚¯ãƒ­ãƒƒãƒ—å¾Œã®ç”»åƒã‚’PoCã§æ¨è«–:
   ```bash
   cd packages/obs-victory-counter/victory-detector

   # ãƒ•ã‚§ãƒ¼ã‚º2.5ã§å®Ÿè£…ã—ãŸå˜ä¸€ç”»åƒæ¨è«–ã‚¹ã‚¯ãƒªãƒ—ãƒˆã‚’ä½¿ç”¨
   uv run python scripts/inference_single_image.py \
     --image ../../ow2-victory-counter-rs/debug/cropped-20251121-143025-123.png \
     --model artifacts/models/victory_classifier.pth \
     --no-crop \
     --output ../../ow2-victory-counter-rs/debug/poc-result-20251121-143025-123.json
   ```

2. æ¨è«–çµæœï¼ˆç¢ºç‡åˆ†å¸ƒï¼‰ã‚’è¨˜éŒ²

**æ³¨æ„**: `--no-crop` ã‚’æŒ‡å®šã™ã‚‹ã“ã¨ã§ã€Rustç‰ˆã®ãƒ‡ãƒãƒƒã‚°ãƒ¢ãƒ¼ãƒ‰ã§ä¿å­˜ã•ã‚ŒãŸã‚¯ãƒ­ãƒƒãƒ—æ¸ˆã¿ç”»åƒã‚’ãã®ã¾ã¾æ¨è«–ã§ãã¾ã™ã€‚

### 3.3 çµæœã®æ¯”è¼ƒåˆ†æ

**æ¯”è¼ƒé …ç›®**:

| ç”»åƒãƒ•ã‚¡ã‚¤ãƒ« | Rustç‰ˆ confidence | PoC confidence | å·®åˆ† | åˆ¤å®š |
|------------|------------------|----------------|------|------|
| cropped-001.png | none=1.00 | none=0.95 | 0.05 | å° |
| cropped-002.png | none=1.00 | victory=0.85 | - | **å¤§** |

**åˆ¤å®šåŸºæº–**:

- **å·®ãŒå°ã•ã„ï¼ˆ< 0.1ï¼‰**: å‰å‡¦ç†ã¯ã»ã¼åŒã˜ â†’ ãƒ¢ãƒ‡ãƒ«ã®å•é¡Œã€ã¾ãŸã¯ã‚¯ãƒ­ãƒƒãƒ—ä½ç½®ã®å•é¡Œ
- **å·®ãŒå¤§ãã„ï¼ˆâ‰¥ 0.1ï¼‰**: **å‰å‡¦ç†ã®é•ã„ãŒåŸå› ** â†’ ãƒ•ã‚§ãƒ¼ã‚º4ã¸

**å¯è¦–åŒ–**ï¼ˆã‚ªãƒ—ã‚·ãƒ§ãƒ³ï¼‰:
```python
import matplotlib.pyplot as plt

# ç¢ºç‡åˆ†å¸ƒã®æ¯”è¼ƒã‚°ãƒ©ãƒ•
classes = ['defeat_pb', 'defeat_text', 'none', 'victory_pb', 'victory_text']
rust_probs = [0.00, 0.00, 1.00, 0.00, 0.00]
poc_probs = [0.05, 0.10, 0.70, 0.10, 0.05]

plt.bar(classes, rust_probs, alpha=0.5, label='Rust')
plt.bar(classes, poc_probs, alpha=0.5, label='PoC')
plt.legend()
plt.show()
```

### 3.4 æ¯”è¼ƒãƒ†ã‚¹ãƒˆçµæœ âœ… å®Œäº†

**å®Ÿæ–½æ—¥**: 2025-01-22

#### ãƒ†ã‚¹ãƒˆãƒ‡ãƒ¼ã‚¿

`data/samples/` ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã‹ã‚‰å„ã‚¯ãƒ©ã‚¹2æšãšã¤ã€åˆè¨ˆ10æšã®ç”»åƒã§ãƒ†ã‚¹ãƒˆã‚’å®Ÿæ–½ã—ã¾ã—ãŸã€‚

#### ç”»åƒåˆ¥æ¯”è¼ƒçµæœ

| # | ã‚«ãƒ†ã‚´ãƒª | ç”»åƒ | PoC | Rust | å·®ç•° | ä¸€è‡´ |
|---|----------|------|-----|------|------|------|
| 1 | defeat_progressbar | 20251110-220009-923 | 0.7731 | 0.8013 | +2.82% | âœ“ |
| 2 | defeat_progressbar | 20251110-222020-453 | 0.8486 | 0.8633 | +1.47% | âœ“ |
| 3 | defeat_text | 20251103_run04_defeat_umiinu | 0.9923 | 0.9927 | +0.04% | âœ“ |
| 4 | defeat_text | 20251103_run04_defeat_umiinu2 | 0.9963 | 0.9964 | +0.01% | âœ“ |
| 5 | victory_progressbar | 20251110-225420-329 | 0.9999523 | 0.9999220 | -0.003% | âœ“ |
| 6 | victory_progressbar | 20251110-225747-670 | 0.9999465 | 0.9998981 | -0.005% | âœ“ |
| 7 | victory_text | 20251103_run04_victory_umiinu | 0.9674 | 0.9680 | +0.06% | âœ“ |
| 8 | victory_text | 20251103_run04_victory_umiinu2 | 0.8541 | 0.8537 | -0.04% | âœ“ |
| 9 | none | 20251110-213650-777 | 0.9914 | 0.9894 | -0.20% | âœ“ |
| 10 | none | 20251110-213704-784 | 0.9999938 | 0.9999852 | -0.0009% | âœ“ |

#### çµ±è¨ˆçš„åˆ†æ

- **äºˆæ¸¬ä¸€è‡´ç‡**: 100% (10/10) - ã™ã¹ã¦ã®ç”»åƒã§åŒã˜ã‚¯ãƒ©ã‚¹ã‚’äºˆæ¸¬
- **å¹³å‡ä¿¡é ¼åº¦å·®**: 0.48%
- **æœ€å¤§å·®ç•°**: 2.82% (defeat_progressbar)
- **æœ€å°å·®ç•°**: 0.0009% (none)

#### ã‚¯ãƒ©ã‚¹åˆ¥å‚¾å‘

| ã‚¯ãƒ©ã‚¹ | å¹³å‡å·®ç•° | å‚¾å‘ |
|--------|---------|------|
| defeat_progressbar | +2.15% | RustãŒã‚„ã‚„é«˜ã„ |
| defeat_text | +0.025% | ã»ã¼åŒç­‰ |
| victory_progressbar | -0.004% | ã»ã¼åŒç­‰ |
| victory_text | +0.01% | ã»ã¼åŒç­‰ |
| none | -0.10% | ã»ã¼åŒç­‰ |

#### çµè«–

âœ… **PoCã¨Rustã®æ¨è«–çµæœã¯å®Ÿç”¨ä¸Šååˆ†ãªç²¾åº¦ã§ä¸€è‡´ã—ã¦ã„ã¾ã™**

**ä¸»ãªç™ºè¦‹**:
1. ã™ã¹ã¦ã®ç”»åƒã§**äºˆæ¸¬ã‚¯ãƒ©ã‚¹ãŒä¸€è‡´**
2. ä¿¡é ¼åº¦ã®å·®ã¯**å¹³å‡0.48%ã¨éå¸¸ã«å°ã•ã„**
3. æœ€å¤§ã§ã‚‚2.82%ã®å·®ã§ã€**å®Ÿé‹ç”¨ã«å½±éŸ¿ãªã—**
4. defeat_progressbarã‚¯ãƒ©ã‚¹ã§ã‚„ã‚„å·®ãŒå¤§ãã„ãŒã€æ­£ã—ã„ã‚¯ãƒ©ã‚¹ã‚’äºˆæ¸¬ã§ãã¦ã„ã‚‹
5. ONNXãƒ¢ãƒ‡ãƒ«ã¯PyTorchãƒ¢ãƒ‡ãƒ«ã¨åŒç­‰ã®æ€§èƒ½ã‚’ç¤ºã—ã¦ã„ã‚‹

**åˆ¤å®š**:
- âœ… **å‰å‡¦ç†ã¯é©åˆ‡** - å¤§ããªå·®ç•°ã¯è¦‹ã‚‰ã‚Œãªã„
- âœ… **ONNXã¸ã®å¤‰æ›ã¯æˆåŠŸ** - ãƒ¢ãƒ‡ãƒ«ã®ç²¾åº¦ã¯ä¿ãŸã‚Œã¦ã„ã‚‹
- âœ… **Rustå®Ÿè£…ã¯æ­£å¸¸** - æ¨è«–ãƒ‘ã‚¤ãƒ—ãƒ©ã‚¤ãƒ³ã¯æ­£ã—ãå‹•ä½œã—ã¦ã„ã‚‹

**none ã‚¯ãƒ©ã‚¹ã® confidence=1.00 ã«ã¤ã„ã¦**:
- å®Ÿéš›ã®ãƒ†ã‚¹ãƒˆç”»åƒã§ã¯ confidence=0.989ã€œ0.999 ã¨é©åˆ‡ãªå€¤
- å®Ÿé‹ç”¨ã§ confidence=1.00 ãŒé »å‡ºã™ã‚‹å ´åˆã¯ã€**ã‚¯ãƒ­ãƒƒãƒ—é ˜åŸŸ**ã‚„**ã‚­ãƒ£ãƒ—ãƒãƒ£ã‚¿ã‚¤ãƒŸãƒ³ã‚°**ã®å•é¡Œã®å¯èƒ½æ€§
- ãƒ¢ãƒ‡ãƒ«ã‚„å‰å‡¦ç†è‡ªä½“ã«å•é¡Œã¯ãªã„

---

## ãƒ•ã‚§ãƒ¼ã‚º4: å¿…è¦ã«å¿œã˜ã¦ä¿®æ­£

### 4.1 ãƒ‘ã‚¿ãƒ¼ãƒ³A: PoCãŒãƒªã‚µã‚¤ã‚ºã—ã¦ã„ãªã„å ´åˆ

**å‰æ**: PoCã§ `--image-size` ãŒæŒ‡å®šã•ã‚Œã¦ãŠã‚‰ãšã€ã‚¯ãƒ­ãƒƒãƒ—å¾Œã®995x550ç”»åƒã‚’ãã®ã¾ã¾ä½¿ç”¨

**å¯¾å¿œ**: Rustç‰ˆã‚‚**ãƒªã‚µã‚¤ã‚ºã‚’å‰Šé™¤**

#### ä¿®æ­£å†…å®¹

**src/predictor/onnx.rs**:

```rust
fn image_to_tensor(&self, image: &DynamicImage) -> Result<Array4<f32>, PredictionError> {
    // ãƒªã‚µã‚¤ã‚ºã›ãšã€ãã®ã¾ã¾ãƒ†ãƒ³ã‚½ãƒ«åŒ–
    let rgb_image = image.to_rgb8();
    let (width, height) = (image.width(), image.height());

    debug!(
        "Converting image to tensor: {}x{} RGB (no resize)",
        width, height
    );

    // NCHW å½¢å¼ã®ãƒ†ãƒ³ã‚½ãƒ«ã‚’ä½œæˆï¼ˆå¯å¤‰ã‚µã‚¤ã‚ºï¼‰
    let mut tensor = Array4::<f32>::zeros((1, 3, height as usize, width as usize));

    // HWC (image) â†’ CHW (tensor) å¤‰æ› + æ­£è¦åŒ–
    for y in 0..height {
        for x in 0..width {
            let pixel = rgb_image.get_pixel(x, y);
            tensor[[0, 0, y as usize, x as usize]] = pixel[0] as f32 / 255.0;
            tensor[[0, 1, y as usize, x as usize]] = pixel[1] as f32 / 255.0;
            tensor[[0, 2, y as usize, x as usize]] = pixel[2] as f32 / 255.0;
        }
    }

    Ok(tensor)
}
```

**æ³¨æ„**: ONNXãƒ¢ãƒ‡ãƒ«ãŒå¯å¤‰ã‚µã‚¤ã‚ºå…¥åŠ›ã‚’å—ã‘ä»˜ã‘ã‚‹ã‹äº‹å‰ç¢ºèªãŒå¿…è¦

### 4.2 ãƒ‘ã‚¿ãƒ¼ãƒ³B: PoCãŒ512x283ã«ãƒªã‚µã‚¤ã‚ºã—ã¦ã„ãŸå ´åˆ

**å‰æ**: PoCã§ `--image-size 512` ãªã©ãŒæŒ‡å®šã•ã‚Œã¦ãŠã‚Šã€ã‚¢ã‚¹ãƒšã‚¯ãƒˆæ¯”ç¶­æŒãƒªã‚µã‚¤ã‚ºã‚’å®Ÿæ–½

**å¯¾å¿œ1**: ã‚¢ã‚¹ãƒšã‚¯ãƒˆæ¯”ç¶­æŒãƒªã‚µã‚¤ã‚ºã«å¤‰æ›´

```rust
fn image_to_tensor(&self, image: &DynamicImage) -> Result<Array4<f32>, PredictionError> {
    const TARGET_WIDTH: u32 = 512;
    const TARGET_HEIGHT: u32 = 283;

    // ã‚¢ã‚¹ãƒšã‚¯ãƒˆæ¯”ç¶­æŒãƒªã‚µã‚¤ã‚º
    let resized = image.resize(
        TARGET_WIDTH,
        TARGET_HEIGHT,
        image::imageops::FilterType::Triangle,
    );

    // è¶³ã‚Šãªã„éƒ¨åˆ†ã‚’é»’ã§ãƒ‘ãƒ‡ã‚£ãƒ³ã‚°ï¼ˆå¿…è¦ã«å¿œã˜ã¦ï¼‰
    // ...
}
```

**å¯¾å¿œ2**: ç¾åœ¨ã®å›ºå®šã‚µã‚¤ã‚ºãƒªã‚µã‚¤ã‚ºã®ã¾ã¾ç¶­æŒï¼ˆãƒªã‚µã‚¤ã‚ºã‚¢ãƒ«ã‚´ãƒªã‚ºãƒ ã®ã¿ç¢ºèªï¼‰

```rust
// æ—¢å­˜ã®ã‚³ãƒ¼ãƒ‰ã¨åŒã˜ï¼ˆå¤‰æ›´ãªã—ï¼‰
let resized = image.resize_exact(
    TARGET_WIDTH,
    TARGET_HEIGHT,
    image::imageops::FilterType::Triangle,
);
```

### 4.3 ONNXãƒ¢ãƒ‡ãƒ«ã®å…¥åŠ›å½¢çŠ¶ã‚’ç¢ºèª

**ç¢ºèªæ–¹æ³•**:

```bash
# ONNXãƒ¢ãƒ‡ãƒ«ã®æƒ…å ±ã‚’è¡¨ç¤º
python -c "
import onnx
model = onnx.load('models/victory_classifier.onnx')
print(model.graph.input[0])
"
```

**æœŸå¾…ã•ã‚Œã‚‹å‡ºåŠ›ä¾‹**:
```
name: "input"
type {
  tensor_type {
    elem_type: 1  # FLOAT
    shape {
      dim { dim_value: 1 }      # batch
      dim { dim_value: 3 }      # channels
      dim { dim_value: 283 }    # heightï¼ˆå›ºå®šï¼‰
      dim { dim_value: 512 }    # widthï¼ˆå›ºå®šï¼‰
    }
  }
}
```

ã¾ãŸã¯:
```
dim { dim_param: "height" }  # å¯å¤‰
dim { dim_param: "width" }   # å¯å¤‰
```

**åˆ¤å®š**:
- `dim_value` ãŒæŒ‡å®š â†’ **å›ºå®šã‚µã‚¤ã‚ºå…¥åŠ›ã®ã¿** â†’ ãƒªã‚µã‚¤ã‚ºå¿…é ˆ
- `dim_param` ãŒæŒ‡å®š â†’ **å¯å¤‰ã‚µã‚¤ã‚ºå…¥åŠ›å¯èƒ½** â†’ ãƒªã‚µã‚¤ã‚ºä¸è¦

### 4.4 æœ€é©ãªå‰å‡¦ç†ã‚’æ±ºå®š

æ¯”è¼ƒãƒ†ã‚¹ãƒˆçµæœã«åŸºã¥ã„ã¦æœ€çµ‚åˆ¤æ–­:

| æ¯”è¼ƒçµæœ | åˆ¤æ–­ | å¯¾å¿œ |
|---------|------|------|
| ç¢ºç‡åˆ†å¸ƒãŒã»ã¼ä¸€è‡´ | å‰å‡¦ç†ã¯å•é¡Œãªã— | ã‚¯ãƒ­ãƒƒãƒ—ä½ç½®ã‚’èª¿æ•´ã€ã¾ãŸã¯ãƒ¢ãƒ‡ãƒ«å†å­¦ç¿’ã‚’æ¤œè¨ |
| ç¢ºç‡åˆ†å¸ƒãŒå¤§ããç•°ãªã‚‹ | å‰å‡¦ç†ã«å•é¡Œã‚ã‚Š | PoCã®å‡¦ç†æ–¹æ³•ã«å®Œå…¨ä¸€è‡´ã•ã›ã‚‹ |
| Rustç‰ˆã®æ–¹ãŒç²¾åº¦ãŒé«˜ã„ | Rustç‰ˆã®å‰å‡¦ç†ãŒå„ªã‚Œã¦ã„ã‚‹ | ç¾åœ¨ã®å®Ÿè£…ã‚’ç¶­æŒ |

---

## å®Ÿè£…ã®å„ªå…ˆé †ä½

### å„ªå…ˆåº¦: æœ€é«˜ â­â­â­

**ãƒ•ã‚§ãƒ¼ã‚º1: PoCã®å‡¦ç†æ–¹æ³•ã‚’ç¢ºèª**
- ã™ãã«å®Ÿè¡Œå¯èƒ½
- å®Ÿè£…ä¸è¦ã€èª¿æŸ»ã®ã¿
- æ‰€è¦æ™‚é–“: 30åˆ†

### å„ªå…ˆåº¦: é«˜ â­â­

**ãƒ•ã‚§ãƒ¼ã‚º2: ãƒ‡ãƒãƒƒã‚°ç”¨ç”»åƒä¿å­˜æ©Ÿèƒ½ã®è¿½åŠ **
- å®Ÿè£…ãŒå¿…è¦
- æ¯”è¼ƒãƒ†ã‚¹ãƒˆã®å‰ææ¡ä»¶
- æ‰€è¦æ™‚é–“: 2-3æ™‚é–“

### å„ªå…ˆåº¦: ä¸­ â­

**ãƒ•ã‚§ãƒ¼ã‚º3: æ¯”è¼ƒãƒ†ã‚¹ãƒˆ**
- ãƒ•ã‚§ãƒ¼ã‚º2å®Œäº†å¾Œã«å®Ÿæ–½
- æ‰‹å‹•ã§ã®ç¢ºèªä½œæ¥­
- æ‰€è¦æ™‚é–“: 1-2æ™‚é–“

### å„ªå…ˆåº¦: ä½ï¼ˆæ¡ä»¶ä»˜ãï¼‰

**ãƒ•ã‚§ãƒ¼ã‚º4: å¿…è¦ã«å¿œã˜ã¦ä¿®æ­£**
- æ¯”è¼ƒçµæœæ¬¡ç¬¬ã§å®Ÿæ–½
- æ‰€è¦æ™‚é–“: 1-4æ™‚é–“ï¼ˆä¿®æ­£å†…å®¹ã«ã‚ˆã‚‹ï¼‰

---

## æœŸå¾…ã•ã‚Œã‚‹æˆæœ

### çŸ­æœŸçš„æˆæœï¼ˆãƒ•ã‚§ãƒ¼ã‚º1-3ï¼‰

1. **åŸå› ã®ç‰¹å®š**: PoCã¨Rustç‰ˆã®æ¨è«–çµæœã®å·®ç•°ã®åŸå› ã‚’ç‰¹å®š
2. **ãƒ‡ãƒ¼ã‚¿ã®è“„ç©**: ãƒ‡ãƒãƒƒã‚°ç”»åƒãƒ»çµæœã®åé›†ã«ã‚ˆã‚Šã€å¾Œç¶šã®æ”¹å–„ä½œæ¥­ã®åŸºç¤ãƒ‡ãƒ¼ã‚¿ã‚’ç¢ºä¿
3. **å¯è¦–åŒ–**: ã‚¯ãƒ­ãƒƒãƒ—é ˜åŸŸã‚„å‰å‡¦ç†çµæœã‚’ç›®è¦–ç¢ºèªå¯èƒ½ã«

### é•·æœŸçš„æˆæœï¼ˆãƒ•ã‚§ãƒ¼ã‚º4ï¼‰

1. **æ¨è«–ç²¾åº¦ã®å‘ä¸Š**: é©åˆ‡ãªå‰å‡¦ç†ã«ã‚ˆã‚Šã€none ã®éå‰°æ¤œçŸ¥ã‚’å‰Šæ¸›
2. **PoCäº’æ›æ€§ã®ç¢ºä¿**: PoCã¨åŒç­‰ã®æ¨è«–çµæœã‚’å®Ÿç¾
3. **ä¿å®ˆæ€§ã®å‘ä¸Š**: ãƒ‡ãƒãƒƒã‚°æ©Ÿèƒ½ã«ã‚ˆã‚Šã€å°†æ¥çš„ãªå•é¡Œã®æ—©æœŸç™ºè¦‹ãŒå¯èƒ½

---

## å‚è€ƒæƒ…å ±

### é–¢é€£ãƒ•ã‚¡ã‚¤ãƒ«

- **PoCå‰å‡¦ç†**: `packages/obs-victory-counter/victory-detector/src/victory_detector/inference/predictor.py`
- **Rustå‰å‡¦ç†**: `packages/ow2-victory-counter-rs/src/predictor/onnx.rs`
- **å­¦ç¿’ãƒ‡ãƒ¼ã‚¿**: `packages/obs-victory-counter/victory-detector/scripts/dataset.py`

### é–¢é€£ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ

- ONNXå¤‰æ›: `packages/obs-victory-counter/victory-detector/scripts/convert_to_onnx.py`
- ãƒ¢ãƒ‡ãƒ«ä»•æ§˜: `packages/ow2-victory-counter-rs/models/victory_classifier.label_map.json`

---

## å®Ÿè£…å±¥æ­´

| ãƒ•ã‚§ãƒ¼ã‚º | ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ | å®Œäº†æ—¥ | å‚™è€ƒ |
|---------|----------|--------|------|
| ãƒ•ã‚§ãƒ¼ã‚º1 | âœ… å®Œäº† | 2025-01-21 | PoCã®å‡¦ç†æ–¹æ³•ã‚’ç¢ºèª |
| ãƒ•ã‚§ãƒ¼ã‚º2 | âœ… å®Œäº† | 2025-01-21 | ãƒ‡ãƒãƒƒã‚°æ©Ÿèƒ½å®Ÿè£…ï¼ˆã‚³ãƒŸãƒƒãƒˆ: c76d487ï¼‰ |
| ãƒ•ã‚§ãƒ¼ã‚º2.5 | âœ… å®Œäº† | 2025-01-21 | å˜ä¸€ç”»åƒæ¨è«–æ©Ÿèƒ½å®Ÿè£…ï¼ˆPoC + Rustï¼‰ |
| ãƒ•ã‚§ãƒ¼ã‚º3 | âœ… å®Œäº† | 2025-01-22 | æ¯”è¼ƒãƒ†ã‚¹ãƒˆå®Ÿæ–½ï¼ˆ10ç”»åƒã§æ¤œè¨¼ï¼‰ |
| ãƒ•ã‚§ãƒ¼ã‚º4 | â­• ä¸è¦ | - | å‰å‡¦ç†ã¯é©åˆ‡ãªãŸã‚å®Ÿæ–½ä¸è¦ |

---

**ä½œæˆæ—¥**: 2025-01-21
**æœ€çµ‚æ›´æ–°æ—¥**: 2025-01-22
**ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹**: âœ… **èª¿æŸ»å®Œäº† - å‰å‡¦ç†ãŠã‚ˆã³ONNXå®Ÿè£…ã¯æ­£å¸¸ã«å‹•ä½œ**
**æ¬¡ã®ã‚¢ã‚¯ã‚·ãƒ§ãƒ³**:
- å®Ÿé‹ç”¨ã§ã®ãƒ¢ãƒ‹ã‚¿ãƒªãƒ³ã‚°ç¶™ç¶š
- confidence=1.00 ãŒé »å‡ºã™ã‚‹å ´åˆã¯ã‚¯ãƒ­ãƒƒãƒ—é ˜åŸŸã®èª¿æ•´ã‚’æ¤œè¨

## ç·æ‹¬

æœ¬èª¿æŸ»ã«ã‚ˆã‚Šã€ä»¥ä¸‹ãŒç¢ºèªã•ã‚Œã¾ã—ãŸï¼š

1. **PoCã¨Rustã®æ¨è«–çµæœã¯å®Ÿç”¨ä¸Šååˆ†ã«ä¸€è‡´ã—ã¦ã„ã‚‹** (å¹³å‡å·®ç•°0.48%)
2. **ONNXã¸ã®å¤‰æ›ã¯æˆåŠŸã—ã¦ãŠã‚Šã€ãƒ¢ãƒ‡ãƒ«ã®ç²¾åº¦ã¯ä¿ãŸã‚Œã¦ã„ã‚‹**
3. **å‰å‡¦ç†ãƒ‘ã‚¤ãƒ—ãƒ©ã‚¤ãƒ³ã¯æ­£ã—ãå®Ÿè£…ã•ã‚Œã¦ã„ã‚‹**
4. **noneã‚¯ãƒ©ã‚¹ã®confidence=1.00å•é¡Œã¯ã€ãƒ¢ãƒ‡ãƒ«ã‚„å‰å‡¦ç†ã§ã¯ãªãã€å®Ÿé‹ç”¨æ™‚ã®ã‚­ãƒ£ãƒ—ãƒãƒ£ã‚¿ã‚¤ãƒŸãƒ³ã‚°ã‚„ã‚¯ãƒ­ãƒƒãƒ—é ˜åŸŸã«èµ·å› ã™ã‚‹å¯èƒ½æ€§ãŒé«˜ã„**

ä»Šå¾Œã€confidence=1.00ãŒé »ç™ºã™ã‚‹å ´åˆã¯ï¼š
- ãƒ‡ãƒãƒƒã‚°ãƒ¢ãƒ¼ãƒ‰ã§ç”»åƒã‚’ä¿å­˜ã—ã€ä½•ãŒå†™ã£ã¦ã„ã‚‹ã‹ç¢ºèª
- ã‚¯ãƒ­ãƒƒãƒ—é ˜åŸŸã®èª¿æ•´ã‚’æ¤œè¨
- ã‚­ãƒ£ãƒ—ãƒãƒ£ã‚¿ã‚¤ãƒŸãƒ³ã‚°ã®è¦‹ç›´ã—ã‚’æ¤œè¨

**èª¿æŸ»ã¯æˆåŠŸè£ã«å®Œäº†ã—ã¾ã—ãŸã€‚** ğŸ‰
