# 初期構想

## 作成するもの

次の2つの成果物を作成しようと考えています。
つまり、2つのプロジェクトを作成することになると考えています。

### 1. オーバーウォッチ2勝敗判定 OBS Studio プラグイン

オーバーウォッチ2をOBS Studioで配信する際に、キャプチャーしている画面の情報を基に勝敗を判定し、勝敗数を保持するPythonプラグイン。

OpenCVが利用できるのではないかと考えています。

将来的にはC/C++(あるいはRust)へ移植するが、プロトタイピングの容易性から今回はPythonで実装します。

### 2. 配信画面に1.で算出した勝敗数を表示するためのHTML

OBS StudioのHTMLブラウザー機能を利用して、画面に勝敗数を表示したいです。
そのためのリソースファイル(アセットファイル)を管理します。

## 初期設計方針

### モノレポのディレクトリ構成

- ルート直下に`packages/obs-victory-counter/`を配置し、その配下を`victory-detector/`（OBS用Pythonスクリプト）と`victory-counter-overlay-ui/`（ブラウザ向けHTML/CSS/JS）に分ける。両者の関係や利用手順は親`README.md`にまとめる。
- 共通の定義や型、静的アセットは将来的に`packages/obs-victory-counter/shared/`へ集約し、プロジェクト間の依存を明示化する。
- プロジェクト固有のドキュメントは各ディレクトリ内の`README.md`に集約し、リポジトリ全体の仕様や設計メモは`docs/`配下に整理する。

### 勝敗判定プラグインの技術方針

- OBSのPythonスクリプト機能（Scripts > Python）として配布し、依存管理は`uv`を基盤とする。`packages/obs-victory-counter/victory-detector/pyproject.toml`に依存を宣言し、`uv add opencv-python numpy`のように追加したうえで`uv lock`を更新する。
- 判定ロジックはテンプレートマッチング＋色抽出の2段階でUI要素を検出し、誤検出を防ぐために連続フレームでの多数決を採用する。
- 長期的な移植を想定し、処理パイプラインを`core/vision.py`・`core/state.py`のように純粋ロジックとOBS連携層を分離する。
- 勝敗判定および手動補正の結果はイベントログ（例: `{ "type": "result"|"adjustment", "value": "victory"|"defeat", "delta": ±1, "timestamp": ... }`）として追記し、状態復元と分析に備える。

### データ受け渡し方式

- Pythonプラグイン側で`127.0.0.1:8912`に`ThreadingHTTPServer`を立ち上げ、集計済みの勝敗カウンタを`/state`（JSON）で公開し、イベントログは`/history`（直近N件）から取得できるようにする。
- HTMLオーバーレイは`fetch`を用いて1秒間隔で`/state`をポーリングし、再接続・タイムアウトを考慮したリトライ処理を実装する。
- 将来的に双方向通信が必要になった場合は同サーバをWebSocket対応（`/ws`）へ拡張し、手動補正用の`POST /adjust`エンドポイントも追加する。API仕様は`docs/specs/api.md`で管理する。

### オーバーレイUIの拡張方針

- 初期表示は勝敗数と対戦回数のみとし、JSONレスポンスの`{ victories, defeats, streak }`をそのまま描画する。
- デザイン調整や多言語対応に備えて、スタイルは`packages/obs-victory-counter/victory-counter-overlay-ui/src/styles/`で管理し、数値フォーマットやテキストは`locales/`に切り出す。
- 履歴や勝率表示などの拡張は、HTTPエンドポイントに新しいフィールドを追加しつつ後方互換を維持する。

### テストとCIの初期方針

- 画像処理ロジックはサンプルフレームを`packages/obs-victory-counter/victory-detector/tests/fixtures/`に置き、pytestで判定結果を確認する。
- オーバーレイはPlaywright等によるスナップショットテストを検討し、最低限はCIで`npm test`（または`vitest`）を実行する。
- GitHub Actionsで両プロジェクトのテストを並列に走らせ、HTTPサーバのポート競合を避けるためモックを利用する。

## 実装フェーズと検証内容

### フェーズ1: 骨組み整備

- `packages/obs-victory-counter/README.md`を作成し、全体のディレクトリ構造とワークスペース設定を明文化する。
- `victory-detector/pyproject.toml`と`uv.lock`の雛形を用意し、`uv run python -V`が通ることを确认する。
- `victory-counter-overlay-ui/package.json`と`package-lock.json`（またはpnpm/pnpm-lock）を用意し、`npm run lint`などの空コマンドが成功するかチェックする。

### フェーズ2: 判定ロジックのスタンドアロン実装

- `victory-detector/src/victory_detector/core`にテンプレートマッチングと色抽出のモジュールを実装する。
- `tests/fixtures/`にサンプルフレームを配置し、`pytest`で勝敗判定が期待通りになるか検証する。
- 判定結果はイベントログ（JSON Lines など）に追記し、再起動時にリプレイしてカウンタを復元できるか確認する。
- CLIスクリプト（例: `uv run python -m victory_detector.cli fixtures/frame.png`）でデバッグ出力を確認する。

### フェーズ3: HTTPサーバ層の追加

- `victory-detector/src/victory_detector/server.py`に`ThreadingHTTPServer`を実装し、最新のカウントを`/state`で返す。
- `curl`や`httpie`で`127.0.0.1:8912/state`へリクエストし、JSONレスポンスが更新されることを確認する。
- pytestでAPIのシリアライズ結果を検証し、異常系（接続不可など）をログに記録する。

### フェーズ3.5: 履歴APIと手動補正準備

- `/history`エンドポイントを追加し、直近のイベントログが取得できることを`curl`で検証する。
- `POST /adjust`のスケルトンを実装し、リクエストを受け取ってイベントログに補正イベントを追記するところまで確認する。
- 認証トークンや入力バリデーションの設計メモを`docs/specs/api.md`に追記し、次フェーズのUI実装に備える。

### フェーズ4: オーバーレイUIのモック実装

- `victory-counter-overlay-ui/src/`にダミーデータを描画するシンプルなUIを作成する。
- `npm start`（または`npm run dev`）でモックサーバを立ち上げ、ブラウザで表示崩れがないか確認する。
- `vitest`や`testing-library`でコンポーネント単位の描画テストを追加する。

### フェーズ5: 実データ接続

- `fetch`による`/state`ポーリングを実装し、`setInterval`や`AbortController`でタイムアウト処理を組み込む。
- ローカルでHTTPサーバを立ち上げた状態でUIを起動し、勝敗カウントがリアルタイムに反映されるか確認する。
- ネットワーク障害を想定し、APIエラー時のリトライやUI上のステータス表示をテストする。
- 管理用UIまたは簡易ツールから`POST /adjust`を呼び出し、補正イベントがログに追加されカウンタへ反映されることを確認する。

### フェーズ6: OBS連携

- OBSのScripts ManagerにPythonスクリプトを読み込ませ、配信キャプチャと連動させる。
- OBSのブラウザソースでオーバーレイを表示し、実際の試合で勝敗カウンタが更新されるか観察する。
- 観戦中に手動補正をトリガーし、オーバーレイと`/history`に即時反映されることを確認する。
- 検証ログやスクリーンショット、問題点を`docs/`配下に記録し、次の改善サイクルの種を残す。

### フェーズ7: 最終調整とCI整備

- カバレッジ計測（例: `pytest --cov`）や`npm run test -- --coverage`を実行し、目標値を満たすか確認する。
- GitHub Actions（`ci.yml`など）に`uv run pytest`と`npm test`を追加し、並列実行で安定するかを検証する。
- リリース手順や利用手引きを`docs/usage.md`や親`README.md`にまとめ、初見でもセットアップできる状態にする。
