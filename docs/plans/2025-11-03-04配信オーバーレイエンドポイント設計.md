# 配信用オーバーレイ専用エンドポイント設計

## 背景

現在の管理 UI (`http://localhost:5173/`) は配信者が勝敗ログを確認・補正するための画面であり、配信画面にそのまま載せるには情報量が多い。配信用にコンパクトな表示を提供するため、Victory Detector にオーバーレイ専用の表示エンドポイントを追加する。

## 提供形態

- エンドポイント: `GET /overlay`
- レスポンス種別: HTML（軽量な単一ファイル）
- 役割分担:
  - 管理画面: 勝敗表示＋補正操作（現状どおり）
  - オーバーレイ: カウントと最近イベントのみを表示、配信者がサイズ・テーマを調整できる

## レイアウト案

- Victory / Defeat / Draw の合計値
- 直近の勝敗履歴（件数はクエリで調整可能）
- 任意: 現在のステータス（更新時刻など）

## カスタマイズ方法

クエリパラメータでレイアウトを調整できるようにする。

| パラメータ | 既定値 | 説明                                                  |
| ---------- | ------ | ----------------------------------------------------- |
| `theme`    | `dark` | `dark` / `light` / `transparent` などのテーマ切り替え |
| `scale`    | `1.0`  | フォントサイズやボックスサイズを倍率調整              |
| `history`  | `3`    | 履歴の表示件数                                        |
| `showDraw` | `true` | Draw の表示有無（不要な場合に非表示）                 |

### カスタム CSS を想定したクラス命名

OBS のブラウザソースで「カスタム CSS」を使う前提で、以下のクラス構造を採用する。

| 対象要素                         | クラス                                                                 | 備考                       |
| -------------------------------- | ---------------------------------------------------------------------- | -------------------------- | ------------- | -------------------------- |
| `<body>`                         | `overlay-body`, `overlay-theme--{dark                                  | light                      | transparent}` | テーマ別の装飾を上書き可能 |
| コンテナ                         | `overlay-root`                                                         | 全体を囲むラッパー         |
| 勝敗サマリー                     | `overlay-summary`                                                      | カードを並べるラッパー     |
| カード                           | `overlay-card` + `overlay-card--victory/defeat/draw`                   | 各種ボーダー色の指定に使用 |
| カード内ラベル/値                | `overlay-card__label`, `overlay-card__value`                           | フォント調整用             |
| 履歴リスト                       | `overlay-history`                                                      | `gap` などを上書き可能     |
| 履歴アイテム                     | `overlay-history__item` + `overlay-history__item--victory/defeat/draw` | 状態別の色分け             |
| タイムスタンプ・値・差分・ノート | `overlay-history__time/value/delta/note`                               | 文字装飾に利用             |

タイムスタンプは `HH:MM:SS` 形式で表示し、イベント発生時刻の把握を容易にする。

クラスに `overlay-` プレフィックスを付けることで、OBS 側でほかの CSS と衝突しにくくする。

## 実装方針

1. `victory_detector/server.py` に `/overlay` ハンドラーを追加。
   - `/state` を内部的に呼び出し、最新サマリを取得。
   - 簡易テンプレートで HTML を生成する。
   - CORS レスポンスは不要だが、`Content-Type: text/html; charset=utf-8` を返す。
2. テンプレートは小さな HTML を Python 内で構築し、スクリプトの配布が容易な形にする。
3. 必要なスタイルはインラインで提供（外部依存ファイルは極力避ける）。
4. クエリの解釈:
   - `history` や `showDraw` はバリデーションを行い、異常値は既定値にフォールバック。
   - テーマの指定が未知の場合は `dark`。
5. OBS ブラウザソースでは `http://127.0.0.1:8912/overlay?theme=transparent&scale=1.2` などで利用できるようにする。

## テスト

- `/overlay` が 200 を返し、HTML 内に勝敗カウントが出力されることを確認するユニットテストを追加。
- クエリパラメータの異常値が既定値にフォールバックすることをテスト。
- 既存の `/state` `/adjust` には影響を与えない。

## 今後の拡張

- 複数のプリセットテーマを増やす。
- draw 表示をアイコン等に置き換える。
- WebSocket ベースでのリアルタイム更新に移行する際も同エンドポイントを踏襲できるようにする。
