# 画像解析 PoC 計画メモ

## ステータス

- 文字領域テンプレート比較による PoC 方針を採用。`poc_detect.py` で既存サンプルを評価したところ、現時点では全件 `score=1.000`（threshold=0.85）で一致。
- 具体的な TODO は `docs/plans/2025-11-03-02フェーズ7TODO.md` のフェーズ7-C に集約した。

## 目的

Victory / Defeat / Draw のバナーを自動検出する手法を調査・試作し、フェーズ8以降で本実装へ繋げるための段取りを整理する。

## 想定シナリオ

1. OBS から取得したキャプチャ画像（スクリーンショット or フレーム単位）を解析し、勝敗バナー／UI 要素を検出する。
2. 判定結果を現行の `StateManager` に渡し、イベントログ・配信用オーバーレイと連携する。

## 技術候補と決定

| 手法                              | 概要                                               | Pros                                         | Cons                                                    |
| --------------------------------- | -------------------------------------------------- | -------------------------------------------- | ------------------------------------------------------- |
| 文字領域テンプレート比較（採用） | 画面中央の文字表示領域のみを切り出し、二値化後に既存テンプレートと相関比較する | 表示位置が固定なら安定・高速・データ少なく導入可 | 色テーマや言語ごとにテンプレートが必要、閾値調整が必要 |
| カラーヒストグラム + ルールベース | バナー領域の色相・輝度で判定                       | 背景色が一定なら実装が簡単                   | カスタムテーマやエフェクトに弱い                        |
| OCR + テキスト検出                | 「VICTORY」「DEFEAT」「DRAW」を文字として判定      | 言語差異に対応しやすい                       | モデル準備・辞書整備が必要、推論コストが高い            |
| ML モデル（YOLO, TensorFlow）     | 事前学習モデルでバナー領域を検出                   | 汎用性と拡張性が高い                         | データ収集・学習コストが高い、PoC のスコープを超える    |

## PoC 方針

1. `template_bbox` で定義された範囲をクロップし、グレースケール + Otsu 二値化で文字形状を強調する。
2. `data/templates/<label>/<variant>/` に保存した基準テンプレートと正規化相関係数を比較し、最大スコアが閾値以上なら一致と判定する。
3. テーマ（デフォルト／umiinu など）や UI 言語ごとにテンプレートを追加し、閾値の妥当性を評価する。
4. 必要であれば OCR や ML を候補に再検討する。

## データセットの準備

- キャプチャ方法: OBS で Victory/Defeat/Draw のスクリーンショットを取得し、`data/samples/` に格納（Git LFS or 外部ストレージを利用）。
- メタ情報: JSON でラベリング (`{ "file": "victory_01.png", "label": "victory", "notes": "default theme" }`)。
- バリエーション: カラーテーマ変更、解像度、UI 言語（英語/日本語）ごとの収集。

## 次のアクション

詳細タスクは TODO リストを参照。進行に合わせて、PoC の結果と実装方針を `docs/specs/architecture.md` に反映する。

- `scripts/export_templates.py` でテンプレートを更新したうえで、`scripts/poc_detect.py` を実行し、スコア分布と閾値を決定する。
- テーマ追加時は `template_bbox`・テンプレート画像を増やし、PoC スクリプトの結果を比較する。

## 成果物

- PoC 実行スクリプト＋サンプル結果（検出可否、誤判定率）。
- 画像データ保管方法、セキュリティ上の注意点（配信映像が含まれる場合の取り扱い）。
- 本実装に向けたステップ（ライブラリ決定、API 変更点、テスト方針）。
