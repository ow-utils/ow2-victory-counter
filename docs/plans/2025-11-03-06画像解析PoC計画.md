# 画像解析 PoC 計画メモ

## ステータス

- 文字領域テンプレート比較による PoC 方針を採用。`poc_detect.py` で既存サンプルを評価したところ、現時点では全件 `score=1.000`（threshold=0.85）で一致。
- 具体的な TODO は `docs/plans/2025-11-03-02フェーズ7TODO.md` のフェーズ7-C に集約した。

## 目的

Victory / Defeat / Draw のバナーを自動検出する手法を調査・試作し、フェーズ8以降で本実装へ繋げるための段取りを整理する。

## 想定シナリオ

1. OBS から取得したキャプチャ画像（スクリーンショット or フレーム単位）を解析し、勝敗バナー／UI 要素を検出する。
2. 判定結果を現行の `StateManager` に渡し、イベントログ・配信用オーバーレイと連携する。

## 技術候補と決定

| 手法                              | 概要                                               | Pros                                         | Cons                                                    |
| --------------------------------- | -------------------------------------------------- | -------------------------------------------- | ------------------------------------------------------- |
| 文字領域テンプレート比較（採用） | 画面中央の文字表示領域のみを切り出し、二値化後に既存テンプレートと相関比較する | 表示位置が固定なら安定・高速・データ少なく導入可 | 色テーマや言語ごとにテンプレートが必要、閾値調整が必要 |
| カラーヒストグラム + ルールベース | バナー領域の色相・輝度で判定                       | 背景色が一定なら実装が簡単                   | カスタムテーマやエフェクトに弱い                        |
| OCR + テキスト検出                | 「VICTORY」「DEFEAT」「DRAW」を文字として判定      | 言語差異に対応しやすい                       | モデル準備・辞書整備が必要、推論コストが高い            |
| ML モデル（YOLO, TensorFlow）     | 事前学習モデルでバナー領域を検出                   | 汎用性と拡張性が高い                         | データ収集・学習コストが高い、PoC のスコープを超える    |

## PoC 方針

1. `template_bbox` で定義された範囲をクロップし、グレースケール + Otsu 二値化で文字形状を強調する。
2. `data/templates/<label>/<variant>/` に保存した基準テンプレートと正規化相関係数を比較し、最大スコアが閾値以上なら一致と判定する。
3. テーマ（デフォルト／umiinu など）や UI 言語ごとにテンプレートを追加し、閾値の妥当性を評価する。
4. `scripts/poc_detect.py --report` を用いてスコア分布を集計し、最小スコア・平均スコアを記録する（現状の最小値は 0.99999976）。推奨閾値は 0.90、警戒ラインは 0.85 とする。
5. 必要であれば OCR や ML を候補に再検討する。

## データセットの準備

- キャプチャ方法: OBS で Victory/Defeat/Draw のスクリーンショットを取得し、`data/samples/` に格納。variant（アクセシビリティ／モード）ごとに `template_bbox` を記録する。
- `scripts/build_dataset.py` を用いて、`data/samples` から `template_bbox` 部分を切り出し、`dataset/<variant>/<label>/` に 128x128 PNG を出力する。`none` クラス用に勝敗画面以外のシーンも追加収集する。
- 学習用データは外部ストレージや Git LFS で共有し、再現性が必要な場合はバージョン管理する。
  
## モデル学習

- `scripts/train_classifier.py` で軽量 CNN を学習し、`artifacts/models/` に学習済みパラメータ（`.pth`）を保存する。
- 推論時は学習済みモデルを `run_capture_monitor_ws.py` などから読み込み、テンプレート照合の代わりに CNN による分類を行う。
- 学習・推論の依存ライブラリとして PyTorch (`torch`/`torchvision`) を `pyproject.toml` に追加済み。GPU が無くても CPU で数ミリ秒程度の推論が可能な構成を目指す。

## 次のアクション

詳細タスクは TODO リストを参照。進行に合わせて、PoC の結果と実装方針を `docs/specs/architecture.md` に反映する。

- `scripts/export_templates.py` でテンプレートを更新したうえで、`scripts/poc_detect.py` を実行し、スコア分布と閾値を決定する。
- テーマ追加時は `template_bbox`・テンプレート画像を増やし、PoC スクリプトの結果を比較する。
- `scripts/check_templates.py` を CI などで実行し、variant ごとにテンプレート PNG が揃っているかを検証する。
- `scripts/train_classifier.py` を用いて CNN モデルを学習し、推論時間や精度を評価する。
- 学習済みモデルを `run_capture_monitor_ws.py` へ組み込み、リアルタイム推論へ切り替える。

## 成果物

- PoC 実行スクリプト＋サンプル結果（検出可否、誤判定率）。
- 画像データ保管方法、セキュリティ上の注意点（配信映像が含まれる場合の取り扱い）。
- 本実装に向けたステップ（ライブラリ決定、API 変更点、テスト方針）。

## 将来の課題

- ライバルプレイ以外のモードや他言語 UI のスクリーンショットを追加し、`template_bbox` / テンプレートを拡充する。
- 複数モードを横断する場合の閾値差分（モードごとの調整テーブル）を検討する。
