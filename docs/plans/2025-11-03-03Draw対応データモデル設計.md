# Draw 対応データモデル設計メモ

## 目的

Victory/Defeat のみを扱っている現在のデータモデルを拡張し、Draw（引き分け）を一貫して扱えるようにする。

## 対象コンポーネントと変更概要

| コンポーネント                  | 現状                                                                         | 変更方針                                                                                                                                                         |
| ------------------------------- | ---------------------------------------------------------------------------- | ---------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| `victory_detector.core.state`   | `Outcome = Literal["victory", "defeat"]`、`CounterState` は勝利/敗北のみ集計 | Outcome に `"draw"` を追加。`CounterState` に `draws: int` を追加し、`total` は勝敗引き分けの合計とする。イベントログ `Event` / `EventDict` も draw を許容する。 |
| `victory_detector.core.vision`  | `DetectionResult.outcome` は `victory/defeat/unknown`                        | 画像解析 PoC 実装時に `"draw"` を返せるよう型を更新。暫定的にはスタブで draw を返さないが、型を先行対応させる。                                                  |
| HTTP API (`/state`, `/history`) | victories/defeats/total フィールドのみ                                       | `draws` フィールドを追加。イベント配列にも draw が含まれる可能性があることを明記。                                                                               |
| `/adjust`                       | `value` に victory/defeat を想定                                             | `value` に `draw` を受け付ける。検証エラーも draw を考慮する。                                                                                                   |
| CLI (`victory_detector.cli`)    | 勝敗のみ出力                                                                 | JSON 出力に `draws` を追加。                                                                                                                                     |
| UI (管理画面)                   | Victory/Defeat のみ表示・補正                                                | `draws` を表示し、手動補正フォームに Draw オプションを追加。History も draw を色分け表示できるよう更新。                                                         |
| `docs/specs/api.md`             | Draw に関する記述なし                                                        | レスポンス例・補正リクエスト例を Draw に対応させる。                                                                                                             |

## 詳細設計

### イベントログ

- `Outcome = Literal["victory", "defeat", "draw"]`
- JSON Lines 形式の 1 行 (`Event`) は `value` に `draw` を許容する。
- 過去ログとの互換性: 既存ログには draw が存在しないため、デシリアライズ時に `draw` が無くても問題なし。新旧混在に影響なし。

### `CounterState`

```python
@dataclass(slots=True)
class CounterState:
    victories: int = 0
    defeats: int = 0
    draws: int = 0
    adjustments: list[Event] = field(default_factory=list)
    results: list[Event] = field(default_factory=list)

    @property
    def total(self) -> int:
        return self.victories + self.defeats + self.draws
```

- `apply()` は `value` に応じて該当カウンタを増加させる。
- イベント配列 (`results`/`adjustments`) はそのまま維持。

### HTTP API

- `/state` レスポンスに `draws` を追加。
- `/history` はイベント列をそのまま返すため、追加作業なし。仕様書の記述を draw 対応に更新。
- `/adjust` のバリデーションを `{"victory", "defeat", "draw"}` に変更。

### CLI

- `cli.run()` の戻り値に `draws` を追加し、`state.StateManager` を通じて draw カウントが反映されるようにする。

### UI (管理画面)

- トップのスコアボードに Draw の表示を追加。
- 手動補正フォームの Outcome セレクトボックスに Draw を追加。
- 履歴リストに draw 用のスタイル（色分け）を追加。

### テスト

- `tests/test_state.py` に draw の自動集計・調整ケースを追加。
- `tests/test_server.py` で `/state`/`/adjust` が draw を返すケースを検証。
- UI 側のテスト (`mockData.test.mjs` など) で draw を含むモックデータを検証。

### 移行手順

1. データモデルと API のコード変更。
2. CLI/テストを draw 対応に更新。
3. UI の表示・フォームを draw 対応に更新。
4. ドキュメント（API 仕様、OBS 連携手順）を更新。

以上をフェーズ7-A の実装指針とする。
