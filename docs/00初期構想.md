# 初期構想

## 作成するもの

次の2つの成果物を作成しようと考えています。
つまり、2つのプロジェクトを作成することになると考えています。

### 1. オーバーウォッチ2勝敗判定 OBS Studio プラグイン

オーバーウォッチ2をOBS Studioで配信する際に、キャプチャーしている画面の情報を基に勝敗を判定し、勝敗数を保持するPythonプラグイン。

OpenCVが利用できるのではないかと考えています。

将来的にはC/C++(あるいはRust)へ移植するが、プロトタイピングの容易性から今回はPythonで実装します。

### 2. 配信画面に1.で算出した勝敗数を表示するためのHTML

OBS StudioのHTMLブラウザー機能を利用して、画面に勝敗数を表示したいです。
そのためのリソースファイル(アセットファイル)を管理します。

## 初期設計方針

### モノレポのディレクトリ構成

- ルート直下に`packages/obs-win-counter/`を配置し、その配下を`win-detector/`（OBS用Pythonスクリプト）と`win-counter-overlay-ui/`（ブラウザ向けHTML/CSS/JS）に分ける。両者の関係や利用手順は親ディレクトリの`README.md`にまとめる。
- 共通の定義や型、静的アセットは将来的に`packages/obs-win-counter/shared/`へ集約し、プロジェクト間の依存を明示化する。
- プロジェクト固有のドキュメントは各ディレクトリ内の`README.md`に集約し、リポジトリ全体の仕様や設計メモは`docs/`配下に整理する。

### 勝敗判定プラグインの技術方針

- OBSのPythonスクリプト機能（Scripts > Python）として配布し、依存管理は`uv`を基盤とする。`packages/obs-win-counter/win-detector/pyproject.toml`に依存を宣言し、`uv add opencv-python numpy`のように追加したうえで`uv lock`を更新する。
- 判定ロジックはテンプレートマッチング＋色抽出の2段階でUI要素を検出し、誤検出を防ぐために連続フレームでの多数決を採用する。
- 長期的な移植を想定し、処理パイプラインを`core/vision.py`・`core/state.py`のように純粋ロジックとOBS連携層を分離する。

### データ受け渡し方式

- Pythonプラグイン側で`127.0.0.1:8912`に`ThreadingHTTPServer`を立ち上げ、直近の勝敗カウンタを`/state`（JSON）と`/history`（オプション）で公開する。
- HTMLオーバーレイは`fetch`を用いて1秒間隔で`/state`をポーリングし、再接続・タイムアウトを考慮したリトライ処理を実装する。
- 将来的に双方向通信が必要になった場合は同サーバをWebSocket対応（`/ws`）へ拡張する想定とし、API仕様は`docs/api.md`で管理する。

### オーバーレイUIの拡張方針

- 初期表示は勝敗数と対戦回数のみとし、JSONレスポンスの`{ wins, losses, streak }`をそのまま描画する。
- デザイン調整や多言語対応に備えて、スタイルは`packages/obs-win-counter/win-counter-overlay-ui/src/styles/`で管理し、数値フォーマットやテキストは`locales/`に切り出す。
- 履歴や勝率表示などの拡張は、HTTPエンドポイントに新しいフィールドを追加しつつ後方互換を維持する。

### テストとCIの初期方針

- 画像処理ロジックはサンプルフレームを`packages/obs-win-counter/win-detector/tests/fixtures/`に置き、pytestで判定結果を確認する。
- オーバーレイはPlaywright等によるスナップショットテストを検討し、最低限はCIで`npm test`（または`vitest`）を実行する。
- GitHub Actionsで両プロジェクトのテストを並列に走らせ、HTTPサーバのポート競合を避けるためモックを利用する。
